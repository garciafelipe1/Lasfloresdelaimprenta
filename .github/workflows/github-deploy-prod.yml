name: Vercel Production Deployment

on:
  push:
    branches: [main]
    paths:
      - "apps/www/**"
  workflow_dispatch:

jobs:
  Deploy-Production:
    runs-on: ubuntu-latest
    environment: TOKEN_VERCEL
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.1

      - name: Compute pnpm store path
        id: pnpm-store
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-store.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Install Dependencies (root)
        run: |
          pnpm install --frozen-lockfile

      - name: Create .env.production for Next.js (apps/www)
        run: |
          mkdir -p apps/www
          {
            echo "DB_URL=${{ secrets.DB_URL }}"
            echo "DB_TOKEN=${{ secrets.DB_TOKEN }}"
            echo "MERCADO_PAGO_TOKEN=${{ secrets.MERCADO_PAGO_TOKEN }}"
            echo "APP_URL=${{ secrets.APP_URL }}"
            echo "S3_URL=${{ secrets.S3_URL }}"
            echo "S3_BUCKET=${{ secrets.S3_BUCKET }}"
            echo "S3_KEY_ID=${{ secrets.S3_KEY_ID }}"
            echo "S3_SECRET=${{ secrets.S3_SECRET }}"
            echo "PAYLOAD_SECRET=${{ secrets.PAYLOAD_SECRET }}"
            echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}"
            echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}"
            echo "MEDUSA_BACKEND_URL=${{ secrets.MEDUSA_BACKEND_URL }}"
            echo "NEXT_PUBLIC_MEDUSA_BACKEND_URL=${{ secrets.MEDUSA_BACKEND_URL }}"
            echo "NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY=${{ secrets.MEDUSA_PUBLISHABLE_KEY }}"
            echo "NEXT_PUBLIC_DEFAULT_REGION=${{ secrets.DEFAULT_REGION }}"
          } > apps/www/.env.production

      - name: Vercel pull (prod)
        run: npx -y vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Vercel deploy (cloud build, prod)
        run: npx -y vercel deploy --prod --yes --token=${{ secrets.VERCEL_TOKEN }}

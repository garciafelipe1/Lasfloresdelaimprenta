name: Vercel Production Deployment

on:
  push:
    branches:
      - main
    paths:
      - "apps/www/**"
  workflow_dispatch:

jobs:
  Deploy-Production:
    runs-on: ubuntu-latest
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      VERCEL_PROJECT_NAME: lasfloresdeiris
    steps:
      # 1Ô∏è‚É£ Clonar repositorio
      - uses: actions/checkout@v4
        name: Checkout Repository
      - run: echo "‚úÖ Repositorio clonado"

      # 2Ô∏è‚É£ Setup Node.js 20
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
      - run: |
          echo "‚úÖ Node.js configurado"
          node -v
          npm -v

      # 3Ô∏è‚É£ Setup pnpm 10.17.x
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.17.1
      - run: |
          echo "‚úÖ pnpm configurado"
          pnpm -v

      # 4Ô∏è‚É£ Cache pnpm store
      - name: Cache pnpm store
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}-v2
          restore-keys: |
            ${{ runner.os }}-pnpm-
      - run: echo "‚úÖ Cache pnpm configurado"

      # 5Ô∏è‚É£ Instalar Vercel CLI
      - name: Install Vercel CLI
        run: |
          set -e
          echo "üîπ Instalando Vercel CLI globalmente"
          npm uninstall -g vercel || true
          npm install -g vercel@36.0.0
          vercel --version
          echo "‚úÖ Vercel CLI instalado"

      # 6Ô∏è‚É£ Instalar dependencias con retry y registry expl√≠cito
      - name: Install Dependencies with Retry
        run: |
          set -e
          echo "üîπ Configurando registry pnpm"
          pnpm config set registry https://registry.npmjs.org/
          RETRIES=3
          for i in $(seq 1 $RETRIES); do
            echo "üîπ Attempt $i of $RETRIES..."
            if pnpm install --frozen-lockfile --prefer-offline; then
              echo "‚úÖ Dependencias instaladas correctamente"
              break
            else
              echo "‚ö† pnpm install fall√≥ en intento $i"
              if [ "$i" -lt "$RETRIES" ]; then
                echo "‚è≥ Reintentando en 15 segundos..."
                sleep 15
              else
                echo "‚ùå No se pudo instalar dependencias despu√©s de $RETRIES intentos"
                exit 1
              fi
            fi
          done

      # 7Ô∏è‚É£ Configurar proyecto Vercel
      - name: Configure Vercel Project
        run: |
          set -e
          echo "üîπ Configurando proyecto Vercel"
          rm -rf .vercel || true
          echo "VERCEL_ORG_ID=${{ secrets.VERCEL_ORG_ID }}" >> $GITHUB_ENV
          echo "VERCEL_PROJECT_ID=${{ secrets.VERCEL_PROJECT_ID }}" >> $GITHUB_ENV
          echo "‚úÖ Proyecto configurado"

      # 8Ô∏è‚É£ Pull variables de Vercel
      - name: Pull Vercel Environment Information
        run: |
          set -e
          echo "üîπ Obteniendo variables de entorno de Vercel"
          VERCEL_ORG_ID=${{ secrets.VERCEL_ORG_ID }} VERCEL_PROJECT_ID=${{ secrets.VERCEL_PROJECT_ID }} vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          echo "‚úÖ Variables de entorno obtenidas"

      # 9Ô∏è‚É£ Crear archivo .env.production
      - name: Create .env.production
        run: |
          set -e
          echo "üîπ Creando .env.production"
          echo "DB_URL=${{ secrets.DB_URL }}" > apps/www/.env.production
          echo "DATABASE_AUTH_TOKEN=${{ secrets.DATABASE_AUTH_TOKEN }}" >> apps/www/.env.production
          echo "MP_ACCESS_TOKEN=${{ secrets.MP_ACCESS_TOKEN }}" >> apps/www/.env.production
          echo "MP_PUBLIC_KEY=${{ secrets.MP_PUBLIC_KEY }}" >> apps/www/.env.production
          echo "MP_CLIENT_ID=${{ secrets.MP_CLIENT_ID }}" >> apps/www/.env.production
          echo "MP_CLIENT_SECRET=${{ secrets.MP_CLIENT_SECRET }}" >> apps/www/.env.production
          echo "MP_WEBHOOK_KEY=${{ secrets.MP_WEBHOOK_KEY }}" >> apps/www/.env.production
          echo "APP_URL=${{ secrets.APP_URL }}" >> apps/www/.env.production
          echo "S3_URL=${{ secrets.S3_URL }}" >> apps/www/.env.production
          echo "S3_BUCKET=${{ secrets.S3_BUCKET }}" >> apps/www/.env.production
          echo "S3_KEY_ID=${{ secrets.S3_KEY_ID }}" >> apps/www/.env.production
          echo "S3_SECRET=${{ secrets.S3_SECRET }}" >> apps/www/.env.production
          echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> apps/www/.env.production
          echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> apps/www/.env.production
          echo "MEDUSA_BACKEND_URL=${{ secrets.MEDUSA_BACKEND_URL }}" >> apps/www/.env.production
          echo "NEXT_PUBLIC_MEDUSA_BACKEND_URL=${{ secrets.MEDUSA_BACKEND_URL }}" >> apps/www/.env.production
          echo "NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY=${{ secrets.MEDUSA_PUBLISHABLE_KEY }}" >> apps/www/.env.production
          echo "NEXT_PUBLIC_DEFAULT_REGION=${{ secrets.DEFAULT_REGION }}" >> apps/www/.env.production
          echo "‚úÖ .env.production creado"

      # üîü Build proyecto
      - name: Build Project
        run: |
          set -e
          echo "üîπ Iniciando build del proyecto"
          pnpm -F apps/www build
          echo "‚úÖ Build completado"

      # 1Ô∏è‚É£1Ô∏è‚É£ Deploy a Vercel
      - name: Deploy Project to Vercel
        run: |
          set -e
          echo "üîπ Iniciando deploy a Vercel"
          VERCEL_ORG_ID=${{ secrets.VERCEL_ORG_ID }} VERCEL_PROJECT_ID=${{ secrets.VERCEL_PROJECT_ID }} vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }}
          echo "‚úÖ Deploy finalizado"

name: Vercel Production Deployment

on:
  push:
    branches:
      - main
    paths:
      - "apps/www/**"
  workflow_dispatch:

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    steps:
      # 1ï¸âƒ£ Clonar repositorio
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Configurar Node.js
      - name: Setup Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18
        

      # 3ï¸âƒ£ Configurar pnpm
      - name: Setup pnpm 10.6.5
        uses: pnpm/action-setup@v3
        with:
          version: 10.6.5
       

      # 4ï¸âƒ£ Cache pnpm store
      - name: Cache pnpm store
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-
        

      # 5ï¸âƒ£ Instalar Vercel CLI
      - name: Install Vercel CLI
        run: |
          set -e
          echo "ğŸ”¹ Activando corepack y pnpm"
          corepack enable
          corepack prepare pnpm@10.6.5 --activate
          echo "ğŸ”¹ Instalando Vercel CLI globalmente"
          pnpm install --global vercel@latest
          vercel --version
          echo "âœ… Vercel CLI instalado"

      # 6ï¸âƒ£ Instalar dependencias con retry
      - name: Install Dependencies with Retry
        working-directory: ./apps/www
        run: |
          set -e
          RETRIES=3
          for i in $(seq 1 $RETRIES); do
            echo "ğŸ”¹ Attempt $i of $RETRIES..."
            if pnpm install --frozen-lockfile --prefer-offline; then
              echo "âœ… Dependencias instaladas correctamente"
              break
            else
              echo "âš  pnpm install fallÃ³ en intento $i"
              if [ "$i" -lt "$RETRIES" ]; then
                echo "â³ Reintentando en 15 segundos..."
                sleep 15
              else
                echo "âŒ No se pudo instalar dependencias despuÃ©s de $RETRIES intentos"
                exit 1
              fi
            fi
          done

      # 7ï¸âƒ£ Pull variables de Vercel
      - name: Pull Vercel Environment Information
        working-directory: ./apps/www
        run: |
          set -e
          echo "ğŸ”¹ Obteniendo variables de entorno de Vercel"
          vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          echo "âœ… Variables de entorno obtenidas"

      # 8ï¸âƒ£ Crear archivo .env.production
      - name: Create .env.production
        working-directory: ./apps/www
        run: |
          set -e
          echo "ğŸ”¹ Creando .env.production"
          {
            echo "DB_URL=${{ secrets.DB_URL }}"
            echo "DATABASE_AUTH_TOKEN=${{ secrets.DATABASE_AUTH_TOKEN }}"
            echo "MP_ACCESS_TOKEN=${{ secrets.MP_ACCESS_TOKEN }}"
            echo "MP_PUBLIC_KEY=${{ secrets.MP_PUBLIC_KEY }}"
            echo "MP_CLIENT_ID=${{ secrets.MP_CLIENT_ID }}"
            echo "MP_CLIENT_SECRET=${{ secrets.MP_CLIENT_SECRET }}"
            echo "MP_WEBHOOK_KEY=${{ secrets.MP_WEBHOOK_KEY }}"
            echo "APP_URL=${{ secrets.APP_URL }}"
            echo "S3_URL=${{ secrets.S3_URL }}"
            echo "S3_BUCKET=${{ secrets.S3_BUCKET }}"
            echo "S3_KEY_ID=${{ secrets.S3_KEY_ID }}"
            echo "S3_SECRET=${{ secrets.S3_SECRET }}"
            echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}"
            echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}"
            echo "MEDUSA_BACKEND_URL=${{ secrets.MEDUSA_BACKEND_URL }}"
          } > .env.production
          echo "âœ… .env.production creado"

      # 9ï¸âƒ£ Build proyecto
      - name: Build Project
        working-directory: ./apps/www
        run: |
          set -e
          echo "ğŸ”¹ Iniciando build del proyecto"
          pnpm run build
          echo "âœ… Build completado"

      # ğŸ”Ÿ Deploy a Vercel
      - name: Deploy Project to Vercel
        working-directory: ./apps/www
        run: |
          set -e
          echo "ğŸ”¹ Iniciando deploy a Vercel"
          vercel deploy --prod --yes --token=${{ secrets.VERCEL_TOKEN }}
          echo "âœ… Deploy finalizado"

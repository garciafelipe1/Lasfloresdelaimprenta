name: Vercel Production Deployment

on:
  push:
    branches:
      - main
    paths:
      - "apps/www/**"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Clonar el repositorio
      - uses: actions/checkout@v4

      # 2️⃣ Configurar pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.6.5

      # 3️⃣ Instalar dependencias en el workspace
      - name: Install Dependencies
        run: pnpm install
        working-directory: ./apps/www

      # 4️⃣ Traer variables de entorno de Vercel
      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: ./apps/www

      # 5️⃣ Crear .env.production para Next.js (si no existe)
      - name: Create .env.production
        run: |
          if [ ! -f .env.production ]; then
            echo "DB_URL=${{ secrets.DB_URL }}" > .env.production
            echo "DATABASE_AUTH_TOKEN=${{ secrets.DATABASE_AUTH_TOKEN }}" >> .env.production
            echo "MP_ACCESS_TOKEN=${{ secrets.MP_ACCESS_TOKEN }}" >> .env.production
            echo "MP_PUBLIC_KEY=${{ secrets.MP_PUBLIC_KEY }}" >> .env.production
            echo "MP_CLIENT_ID=${{ secrets.MP_CLIENT_ID }}" >> .env.production
            echo "MP_CLIENT_SECRET=${{ secrets.MP_CLIENT_SECRET }}" >> .env.production
            echo "MP_WEBHOOK_KEY=${{ secrets.MP_WEBHOOK_KEY }}" >> .env.production
            echo "APP_URL=${{ secrets.APP_URL }}" >> .env.production
            echo "S3_URL=${{ secrets.S3_URL }}" >> .env.production
            echo "S3_BUCKET=${{ secrets.S3_BUCKET }}" >> .env.production
            echo "S3_KEY_ID=${{ secrets.S3_KEY_ID }}" >> .env.production
            echo "S3_SECRET=${{ secrets.S3_SECRET }}" >> .env.production
            echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env.production
            echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> .env.production
            echo "MEDUSA_BACKEND_URL=${{ secrets.MEDUSA_BACKEND_URL }}" >> .env.production
          fi
        working-directory: ./apps/www

      # 6️⃣ Construir proyecto
      - name: Build Project
        run: pnpm run build
        working-directory: ./apps/www

      # 7️⃣ Desplegar a Vercel
      - name: Deploy to Vercel
        run: vercel deploy --prod --yes --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: ./apps/www
